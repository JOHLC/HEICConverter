name: Build and Validate

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install ImageMagick
      run: |
        winget install -e --id ImageMagick.ImageMagick --accept-source-agreements --accept-package-agreements
    
    - name: Verify ImageMagick Installation
      run: |
        magick -version
        Write-Host "‚úÖ ImageMagick is available"
    
    - name: Install PS2EXE Module
      run: |
        Install-Module -Name PS2EXE -Force -AllowClobber -Scope CurrentUser
        $module = Get-Module -Name PS2EXE -ListAvailable
        Write-Host "‚úÖ PS2EXE module installed - Version: $($module.Version)"
    
    - name: Run Validation Script
      run: |
        cd scripts
        .\validate.ps1
    
    - name: Validate PowerShell Script Syntax
      run: |
        $scriptPath = "build/PS2EXE/HEICConverter.ps1"
        $errors = $null
        $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $scriptPath -Raw), [ref]$errors)
        if ($errors) {
          Write-Error "PowerShell syntax errors found:"
          $errors | ForEach-Object { Write-Error $_ }
          exit 1
        } else {
          Write-Host "‚úÖ PowerShell script syntax is valid"
        }
    
    - name: Test Build Executable
      run: |
        cd build/PS2EXE
        .\PS2EXE.ps1
        if (-not (Test-Path "HEICConverter.exe")) {
          Write-Error "‚ùå Failed to build executable"
          exit 1
        } else {
          Write-Host "‚úÖ Executable built successfully"
          $exe = Get-Item "HEICConverter.exe"
          Write-Host "üìä Build Statistics:"
          Write-Host "   File size: $([math]::Round($exe.Length / 1MB, 2)) MB"
          Write-Host "   Build time: $($exe.LastWriteTime)"
          Write-Host "   Full path: $($exe.FullName)"
        }
    
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: HEICConverter-exe-${{ github.sha }}
        path: build/PS2EXE/HEICConverter.exe
        retention-days: 30
    
    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.sha }}
        path: |
          **/*.log
          **/*.txt
        retention-days: 7